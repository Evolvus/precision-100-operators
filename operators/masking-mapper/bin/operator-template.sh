#!/bin/bash

CONTAINER=$1
INDEX=$(echo $2 | cut -d ',' -f 1)
FILE_NAME=$(echo $2 | cut -d ',' -f 2)
FILE_TYPE=$(echo $2 | cut -d ',' -f 3)
CONNECTION_NAME=$(echo $2 | cut -d ',' -f 4)


if test "$PRECISION100_RUNTIME_SIMULATION_MODE" = "TRUE"; then
   echo "        START MASKING-MAPPER ADAPTOR $FILE_NAME"
   sleep $PRECISION100_RUNTIME_SIMULATION_SLEEP;
   echo "        END MASKING-MAPPER ADAPTOR $FILE_NAME"
   exit;
fi

echo "        START MASKING-MAPPER ADAPTOR $FILE_NAME"
source $PRECISION100_OPERATORS_FOLDER/masking-mapper/conf/.operator.env.sh

SOURCE_FILE="$PRECISION100_EXECUTION_CONTAINER_FOLDER/$CONTAINER/$FILE_NAME"

I_TABLE_SQL=$MASKING_MAPPER_WORK_FOLDER/"I-${FILE_NAME}.sql"

$PRECISION100_BIN_FOLDER/audit.sh  $0 "PRE-MASKING-MAPPER" "$CONTAINER / $FILE_NAME" "MASKING-MAPPER" $0 "START"

echo "        MASKING-MAPPER ADAPTOR CREATING INSERT TABLE SCRIPT"
$PRECISION100_OPERATORS_FOLDER/masking-mapper/bin/masking-mapper-i-table.sh $FILE_NAME > $I_TABLE_SQL

CONNECTION_STRING=$($PRECISION100_BIN_FOLDER/get-connection-string.sh "$CONNECTION_NAME")

echo "        MASKING-MAPPER ADAPTOR EXECUTING SCRIPTS"
sqlplus -s /nolog << EOL
CONNECT $CONNECTION_STRING
SET FEEDBACK OFF

@$I_TABLE_SQL
COMMIT
EXIT
EOL

$PRECISION100_BIN_FOLDER/audit.sh  $0 "POST-MASKING-MAPPER" "$CONTAINER / $FILE_NAME" "MASKING-MAPPER" $0 "END"

echo "        END MASKING-MAPPER ADAPTOR $FILE_NAME"
