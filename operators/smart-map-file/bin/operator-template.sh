#!/bin/bash

CONTAINER=$1
INDEX=$(echo $2 | cut -d ',' -f 1)
FILE_NAME=$(echo $2 | cut -d ',' -f 2)
FILE_TYPE=$(echo $2 | cut -d ',' -f 3)
CONNECTION_NAME=$(echo $2 | cut -d ',' -f 4)


if test "$PRECISION100_RUNTIME_SIMULATION_MODE" = "TRUE"; then
   echo "        START SMART-MAP-FILE ADAPTOR $FILE_NAME"
   sleep $PRECISION100_RUNTIME_SIMULATION_SLEEP;
   echo "        END SMART-MAP-FILE ADAPTOR $FILE_NAME"
   exit;
fi

echo "        START SMART-MAP-FILE ADAPTOR $FILE_NAME"
source $PRECISION100_OPERATORS_FOLDER/smart-map-file/conf/.operator.env.sh

SOURCE_FILE="$PRECISION100_EXECUTION_CONTAINER_FOLDER/$CONTAINER/$FILE_NAME.$MAP_FILE_FILE_SUFFIX"
TEMP_FILE_1="$PRECISION100_OPERATOR_SMART_MAP_FILE_WORK_FOLDER/$FILE_NAME.$MAP_FILE_FILE_SUFFIX.t1"
TEMP_FILE_2="$PRECISION100_OPERATOR_SMART_MAP_FILE_WORK_FOLDER/$FILE_NAME.$MAP_FILE_FILE_SUFFIX.t2"
DDL_SOURCE_FILE="$PRECISION100_OPERATOR_SMART_MAP_FILE_WORK_FOLDER/$FILE_NAME.$MAP_FILE_FILE_SUFFIX.ddl"
JOIN_SOURCE_FILE="$PRECISION100_OPERATOR_SMART_MAP_FILE_WORK_FOLDER/$FILE_NAME.$MAP_FILE_FILE_SUFFIX.join"
MAP_FILE_DELIMITER=${DEFAULT_MAP_FILE_DELIMITER:-~}


cat $SOURCE_FILE | cut -d $'\t' -f 1 | tr '[:lower:]' '[:upper:]' | tr -s ')' ' ' | tr -s '(' ' ' | tr -s '[:punct:]' ' ' > $TEMP_FILE_1
awk -f $PRECISION100_OPERATORS_FOLDER/smart-map-file/bin/dict.awk $PRECISION100_OPERATORS_FOLDER/smart-map-file/bin/dict.dat $TEMP_FILE_2

grep -i -v ${MAP_FILE_JOIN_FILTER} $TEMP_FILE_2 > "$DDL_SOURCE_FILE"
grep ${MAP_FILE_JOIN_FILTER} $TEMP_FILE_2 |  tr -d "$MAP_FILE_DELIMTER" |  sed -n "s/${MAP_FILE_JOIN_FILTER}//p" > "$JOIN_SOURCE_FILE"

O_TABLE_SQL=$PRECISION100_OPERATOR_SMART_MAP_FILE_WORK_FOLDER/"${DEFAULT_TABLE_NAME_PREFIX}-${FILE_NAME}.sql"
O_TAB_COLUMN_SQL=$PRECISION100_OPERATOR_SMART_MAP_FILE_WORK_FOLDER/"${DEFAULT_TABLE_NAME_PREFIX}-${FILE_NAME}-${DEFAULT_TAB_COLUMN_SUFFIX}.sql"
TRANSFORM_SQL=$PRECISION100_OPERATOR_SMART_MAP_FILE_WORK_FOLDER/"${DEFAULT_TABLE_NAME_PREFIX}-${FILE_NAME}-${DEFAULT_TRANSFORM_SUFFIX}.sql"

$PRECISION100_BIN_FOLDER/audit.sh  $0 "PRE-SMART-MAP-FILE" "$CONTAINER / $FILE_NAME" "SMART-MAP-FILE" $0 "START"

echo "        SMART-MAP-FILE ADAPTOR CREATING O_ TABLE SCRIPT"
$PRECISION100_OPERATORS_FOLDER/smart-map-file/bin/map-file-o-table.sh $FILE_NAME $DDL_SOURCE_FILE > $O_TABLE_SQL

echo "        SMART-MAP-FILE ADAPTOR CREATING INSERT TABLE METADATA SCRIPT"
$PRECISION100_OPERATORS_FOLDER/smart-map-file/bin/map-file-tab-columns.sh $FILE_NAME $DDL_SOURCE_FILE > $O_TAB_COLUMN_SQL

echo "        SMART-MAP-FILE ADAPTOR CREATING TRANSFORM SCRIPT"
$PRECISION100_OPERATORS_FOLDER/smart-map-file/bin/map-file-transform.sh $FILE_NAME $DDL_SOURCE_FILE $JOIN_SOURCE_FILE > $TRANSFORM_SQL

CONNECTION_STRING=$($PRECISION100_BIN_FOLDER/get-connection-string.sh "$CONNECTION_NAME")

echo "        SMART-MAP-FILE ADAPTOR EXECUTING SCRIPTS"
sqlplus -s /nolog << EOL
CONNECT $CONNECTION_STRING
SET FEEDBACK OFF

@$O_TABLE_SQL
@$O_TAB_COLUMN_SQL
@$TRANSFORM_SQL

EOL


$PRECISION100_BIN_FOLDER/audit.sh  $0 "POST-SMART-MAP-FILE" "$CONTAINER / $FILE_NAME" "SMART-MAP-FILE" $0 "END"

echo "        END SMART-MAP-FILE ADAPTOR $FILE_NAME"
